esphome:
  name: esp32-p4-satellite
  friendly_name: "ESP32-P4 Voice Satellite"
  project:
    name: "waveshare.esp32_p4_mic_ha"
    version: "2.0"
  platformio_options:
    # Use standard flash mode for better compatibility
    board_build.arduino.memory_type: dio_qspi
  on_boot:
    - priority: -200
      then:
        # Enable the onboard amplifier (GPIO53) immediately on boot
        - switch.turn_on: amp_enable
        - delay: 200ms
        # Initialize the ES8311 DAC volume to a safe 80%
        - audio_dac.set_volume:
            id: es8311_dac
            volume: 80%

esp32:
  # The P4 is a newer high-performance ESP32 variant with Ethernet and high pin count
  board: esp32-p4-evboard
  variant: esp32p4
  flash_size: 16MB
  framework:
    type: esp-idf
    advanced:
      # Required for some P4-specific hardware features in ESP-IDF
      enable_idf_experimental_features: yes

logger:
  # Use the standard UART0 for serial logging
  hardware_uart: UART0
  level: INFO # Reduced from DEBUG for stability
  logs:
    # Keep audio logs for now, but reduce everything else
    i2s_audio: INFO
    i2s_audio.speaker: INFO
    speaker: INFO
    micro_wake_word: INFO
    # Filter out noisy components once stable
    component: INFO
    ethernet: INFO
    api: INFO
    api.connection: INFO
    mdns: INFO
    safe_mode: INFO

globals:
  - id: has_tts_response
    type: bool
    initial_value: 'false'

# -------------------------------------------------------------------
# NETWORK CONNECTIVITY (Ethernet)
# -------------------------------------------------------------------
# The Waveshare ESP32-P4 uses an IP101 PHY for high-speed Ethernet
ethernet:
  type: IP101
  mdc_pin: GPIO31
  mdio_pin: GPIO52
  power_pin: GPIO51
  clk:
    mode: CLK_EXT_IN
    pin: GPIO50
  phy_addr: 1
  domain: ".local"

api:
  encryption:
    key: !secret encryption_key
  on_client_connected:
    - logger.log: "Home Assistant API connected!"
    # Start Wake Word detection once HA is connected and ready
    - micro_wake_word.start:
    - lambda: |-
        id(va_state).publish_state("Ready (Hey Jarvis)");
  on_client_disconnected:
    - logger.log: "Home Assistant API disconnected!"
    # Stop everything on disconnect to save power and bus resources
    - voice_assistant.stop:
    - micro_wake_word.stop:
    - lambda: |-
        id(va_state).publish_state("No API Connection");

ota:
  - platform: esphome
    password: !secret wifi_password

# -------------------------------------------------------------------
# I2C & AUDIO CODEC (ES8311)
# -------------------------------------------------------------------
# The ES8311 handles the Digital-to-Analog conversion for the speaker.
# We use it solely as a DAC here; microphone input is handled via I2S directly.
i2c:
  sda: GPIO7
  scl: GPIO8
  scan: true
  id: bus_a
  frequency: 100kHz

audio_dac:
  - platform: es8311
    id: es8311_dac
    i2c_id: bus_a
    address: 0x18
    use_mclk: True
    use_microphone: False
    mic_gain: 42DB
    sample_rate: 16000
    bits_per_sample: 16bit

# -------------------------------------------------------------------
# I2S AUDIO BUS CONFIGURATION
# -------------------------------------------------------------------
# Crucial: Since we have one physical I2S bus shared between Mic and Speaker,
# ESPHome's 'try_lock' mechanism ensures they don't fight for the bus.
# We must manually 'stop' the active component before starting the other.
i2s_audio:
  - id: i2s_bus
    i2s_mclk_pin: GPIO13
    i2s_bclk_pin: GPIO12
    i2s_lrclk_pin: GPIO10
    use_legacy: false

# -------------------------------------------------------------------
# AUDIO SPEAKER PIPELINE
# -------------------------------------------------------------------
# We use a Mixer/Resampler pipeline to allow both Radio/TTS and Notifications
# to flow to the same I2S hardware sink.
speaker:
  - platform: i2s_audio
    id: i2s_speaker_out
    dac_type: external
    i2s_audio_id: i2s_bus
    i2s_dout_pin: GPIO9
    audio_dac: es8311_dac
    channel: mono
    num_channels: 1
    # Increased buffer to handle network jitter and prevent TTS dropping out
    buffer_duration: 1000ms
    sample_rate: 16000
    bits_per_sample: 16bit

  - platform: resampler
    id: announcement_spk_resampler
    output_speaker: i2s_speaker_out

# -------------------------------------------------------------------
# MICROPHONE CONFIGURATION
# -------------------------------------------------------------------
# MICROPHONE CONFIGURATION
# -------------------------------------------------------------------
microphone:
  - platform: i2s_audio
    id: my_mic
    i2s_audio_id: i2s_bus
    i2s_din_pin: GPIO11
    adc_type: external
    bits_per_channel: default

# -------------------------------------------------------------------
# MICRO WAKE WORD (WASH/HEY JARVIS)
# -------------------------------------------------------------------
micro_wake_word:
  models:
    - model: hey_jarvis
      probability_cutoff: 0.6
      sliding_window_size: 5
  on_wake_word_detected:
    - logger.log:
        format: ">>> WAKE WORD DETECTED! <<<"
        level: WARN
    - lambda: |-
        id(va_state).publish_state("Wake Word detected!");
    # RELEVANT: Stop MWW immediately to release the I2S lock
    # This allows the Voice Assistant pipeline to prepare the mic.
    - micro_wake_word.stop:
    # Wake up the Devolo Giga Bridge from power-saving mode
    # A single UDP dummy packet before starting the audio stream "opens" the connection
    - lambda: |-
        int sock = ::socket(AF_INET, SOCK_DGRAM, IPPROTO_IP);
        if (sock >= 0) {
            struct sockaddr_in dest_addr;
            dest_addr.sin_addr.s_addr = inet_addr("192.168.178.26");
            dest_addr.sin_family = AF_INET;
            dest_addr.sin_port = htons(9);
            const char* payload = "WAKEUP!";
            sendto(sock, payload, strlen(payload), 0, (struct sockaddr *)&dest_addr, sizeof(dest_addr));
            close(sock);
        }
    # Small delay to ensure the driver and network are ready
    - delay: 100ms
    # Start the Voice Assistant (no sound here to be as snappy as possible!)
    - voice_assistant.start:

# -------------------------------------------------------------------
# VOICE ASSISTANT PIPELINE
# -------------------------------------------------------------------
voice_assistant:
  id: va
  microphone: my_mic
  speaker: announcement_spk_resampler
  noise_suppression_level: 1
  auto_gain: 31dBFS
  volume_multiplier: 1.0

  on_listening:
    - globals.set:
        id: has_tts_response
        value: 'false'
    - logger.log:
        level: WARN
        format: "VA: Listening..."
    - lambda: |-
        id(va_state).publish_state("Listening...");

  on_stt_vad_end:
    - logger.log:
        level: WARN
        format: "VA: Speech detected, stopping mic for feedback..."
    - lambda: |-
        id(va_state).publish_state("Processing...");
    # STEP 1: Manually stop the Wake Word engine so the Speaker can acquire the I2S Bus lock
    - micro_wake_word.stop:
    # We ALSO explicitly stop the mic, just to be absolutely certain the bus is freed
    - lambda: 'id(my_mic).stop();'
    # STEP 2: Wait 300ms for the driver to fully release the hardware bus
    - delay: 300ms
    # STEP 3: Play 'Primer' (short silence) to wake up the DMA/DAC pipeline
    - lambda: |-
        std::vector<uint8_t> primer(3200, 0);
        id(announcement_spk_resampler).play(primer.data(), primer.size());
    - delay: 200ms
    # STEP 4: Play the actual notification sound ('Pling') from embedded PCM array
    # This array is defined inline as PROGMEM to save RAM and avoid external files.
    - lambda: |-
        static const uint8_t NOTIFICATION_PCM[] PROGMEM = {
        0x49, 0x4e, 0x46, 0x4f, 0x49, 0x53, 0x46, 0x54, 0x0d, 0x00, 0x00, 0x00, 0x4c, 0x61, 0x76, 0x66, 0x36, 0x32, 0x2e, 0x33,
        0x2e, 0x31, 0x30, 0x30, 0x00, 0x00, 0x64, 0x61, 0x74, 0x61, 0xc0, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0x01, 0x00, 0x02, 0x00, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0x00, 0x01, 0x00,
        0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xff, 0xff,
        0x01, 0x00, 0xff, 0xff, 0xfe, 0xff, 0x01, 0x00, 0x02, 0x00, 0xff, 0xff, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00,
        0x01, 0x00, 0xfe, 0xff, 0x00, 0x00, 0x01, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0x00, 0x00, 0x03, 0x00,
        0x00, 0x00, 0x02, 0x00, 0x03, 0x00, 0xfe, 0xff, 0x02, 0x00, 0x04, 0x00, 0xfb, 0xff, 0xfb, 0xff, 0x01, 0x00, 0xfe, 0xff,
        0xfe, 0xff, 0x04, 0x00, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0xfa, 0xff, 0xfb, 0xff, 0x03, 0x00, 0x06, 0x00,
        0x01, 0x00, 0xfd, 0xff, 0xfe, 0xff, 0xfb, 0xff, 0xfc, 0xff, 0x06, 0x00, 0x0d, 0x00, 0x07, 0x00, 0xfc, 0xff, 0xf4, 0xff,
        0xf5, 0xff, 0xfd, 0xff, 0x08, 0x00, 0x0a, 0x00, 0x00, 0x00, 0xf9, 0xff, 0xff, 0xff, 0x06, 0x00, 0x04, 0x00, 0x00, 0x00,
        0x04, 0x00, 0x03, 0x00, 0xf8, 0xff, 0xfb, 0xff, 0x03, 0x00, 0xf2, 0xff, 0xf5, 0xff, 0x12, 0x00, 0x07, 0x00, 0xf5, 0xff,
        0x08, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x0a, 0x00, 0xfa, 0xff, 0xee, 0xff, 0x03, 0x00, 0xfe, 0xff, 0xf7, 0xff, 0x0b, 0x00,
        0xfe, 0xff, 0xf1, 0xff, 0x0b, 0x00, 0x09, 0x00, 0xfd, 0xff, 0x0d, 0x00, 0xff, 0xff, 0xf4, 0xff, 0x14, 0x00, 0x07, 0x00,
        0xe2, 0xff, 0xf7, 0xff, 0x09, 0x00, 0xf6, 0xff, 0x02, 0x00, 0x14, 0x00, 0xfd, 0xff, 0xf0, 0xff, 0x05, 0x00, 0x0e, 0x00,
        0x00, 0x00, 0xfa, 0xff, 0x05, 0x00, 0x17, 0x00, 0x13, 0x00, 0xe5, 0xff, 0xca, 0xff, 0xe8, 0xff, 0x0a, 0x00, 0x19, 0x00,
        0x1f, 0x00, 0x10, 0x00, 0x03, 0x00, 0x07, 0x00, 0xf7, 0xff, 0xe4, 0xff, 0xf5, 0xff, 0x15, 0x00, 0x19, 0x00, 0xe9, 0xff,
        0xcb, 0xff, 0x03, 0x00, 0x1c, 0x00, 0xef, 0xff, 0x10, 0x00, 0x42, 0x00, 0x07, 0x00, 0xea, 0xff, 0x08, 0x00, 0xda, 0xff,
        0xc3, 0xff, 0x06, 0x00, 0x1b, 0x00, 0x0f, 0x00, 0x14, 0x00, 0xf6, 0xff, 0xfc, 0xff, 0x2b, 0x00, 0xfb, 0xff, 0xbf, 0xff,
        0xf9, 0xff, 0x1f, 0x00, 0xf9, 0xff, 0x0f, 0x00, 0x35, 0x00, 0xe9, 0xff, 0xbd, 0xff, 0x0b, 0x00, 0x1d, 0x00, 0xe8, 0xff,
        0xf2, 0xff, 0x0b, 0x00, 0x1c, 0x00, 0x3c, 0x00, 0x0b, 0x00, 0xc8, 0xff, 0xed, 0xff, 0xed, 0xff, 0xb9, 0xff, 0x04, 0x00,
        0x43, 0x00, 0x00, 0x00, 0x10, 0x00, 0x4a, 0x00, 0xfe, 0xff, 0xbe, 0xff, 0xe9, 0xff, 0x17, 0x00, 0x15, 0x00, 0xe7, 0xff,
        0xd1, 0xff, 0xf7, 0xff, 0x05, 0x00, 0xfd, 0xff, 0x0e, 0x00, 0x21, 0x00, 0x38, 0x00, 0x38, 0x00, 0xee, 0xff, 0xb7, 0xff,
        0xd5, 0xff, 0xfc, 0xff, 0x00, 0x00, 0xf1, 0xff, 0xf9, 0xff, 0x21, 0x00, 0x29, 0x00, 0x0c, 0x00, 0xf2, 0xff, 0xed, 0xff,
        0x05, 0x00, 0xfe, 0xff, 0xf4, 0xff, 0x18, 0x00, 0x03, 0x00, 0xdc, 0xff, 0x18, 0x00, 0x20, 0x00, 0xc9, 0xff, 0xe1, 0xff,
        0x1f, 0x00, 0xec, 0xff, 0xee, 0xff, 0x1c, 0x00, 0x00, 0x00, 0x1a, 0x00, 0x2e, 0x00, 0x04, 0x00, 0x21, 0x00, 0xfc, 0xff,
        0xaa, 0xff, 0xf6, 0xff, 0x12, 0x00, 0xd7, 0xff, 0x05, 0x00, 0x10, 0x00, 0xe3, 0xff, 0x1e, 0x00, 0x39, 0x00, 0xeb, 0xff,
        0xf3, 0xff, 0x24, 0x00, 0xe3, 0xff, 0xce, 0xff, 0x05, 0x00, 0xf2, 0xff, 0xff, 0xff, 0x2b, 0x00, 0x14, 0x00, 0x0b, 0x00,
        0xe6, 0xff, 0xb7, 0xff, 0x0e, 0x00, 0x5e, 0x00, 0x1b, 0x00, 0xcf, 0xff, 0xcc, 0xff, 0xe1, 0xff, 0x1f, 0x00, 0x59, 0x00,
        0x20, 0x00, 0xb1, 0xff, 0xd4, 0xff, 0x63, 0x00, 0x22, 0x00, 0x98, 0xff, 0xfe, 0xff, 0x2b, 0x00, 0xe2, 0xff, 0xec, 0xff,
        0xdf, 0xff, 0x2c, 0x00, 0x5b, 0x00, 0xd2, 0xff, 0xde, 0xff, 0x30, 0x00, 0x24, 0x00, 0xfa, 0xff, 0xaa, 0xff, 0x0a, 0x00,
        0x50, 0x00, 0x75, 0xff, 0x32, 0xff, 0xf9, 0xff, 0x91, 0x00, 0x5f, 0x00, 0xcb, 0xff, 0x06, 0x00, 0x89, 0x00, 0x3d, 0x00,
        0xbd, 0xff, 0xba, 0xff, 0x1b, 0x00, 0x0b, 0x00, 0xde, 0xff, 0x5b, 0x00, 0x39, 0x00, 0x9b, 0xff, 0xab, 0xff, 0xfe, 0xff,
        0x6c, 0x00, 0x76, 0x00, 0x01, 0x00, 0xaf, 0xff, 0x8d, 0xff, 0xac, 0xff, 0x87, 0xff, 0xb0, 0xff, 0x9c, 0x00, 0xd7, 0x00,
        0x4e, 0x00, 0xa3, 0xff, 0x03, 0x00, 0xb8, 0x00, 0x68, 0xff, 0xf1, 0xfe, 0x7c, 0x00, 0xcb, 0x00, 0xdd, 0xff, 0x30, 0xff,
        0xe8, 0xff, 0x92, 0x00, 0x1d, 0x00, 0x70, 0x00, 0xe5, 0xff, 0x00, 0xff, 0x2d, 0x00, 0x1d, 0x00, 0xc6, 0xfe, 0x93, 0xff,
        0x47, 0x01, 0x3a, 0x01, 0x22, 0x00, 0x22, 0x00, 0x47, 0x00, 0xa9, 0xff, 0x90, 0xff, 0xd5, 0xff, 0xc9, 0xff, 0x6a, 0xff,
        0x4e, 0xff, 0xe5, 0xff, 0x6f, 0x00, 0x5e, 0x00, 0x69, 0x00, 0x84, 0x01, 0x78, 0x01, 0xdd, 0xfe, 0x2b, 0xfe, 0x4f, 0x00,
        0x8f, 0x00, 0x8d, 0xfe, 0xbf, 0xfd, 0x98, 0xff, 0x39, 0x02, 0x9f, 0x02, 0x56, 0x00, 0x7c, 0xfe, 0x07, 0x00, 0xfd, 0x01,
        0xe2, 0xff, 0x66, 0xfd, 0xf3, 0xfe, 0xaa, 0x00, 0x1a, 0x00, 0xea, 0xff, 0x3c, 0x00, 0x43, 0x00, 0xa5, 0x00, 0x77, 0x00,
        0xc8, 0xff, 0x0f, 0x00, 0xcf, 0xff, 0xed, 0xfe, 0x9c, 0xff, 0x09, 0x00, 0x66, 0xff, 0xde, 0xff, 0x40, 0x01, 0xf4, 0x01,
        0x40, 0x00, 0x03, 0xff, 0x61, 0x00, 0xc8, 0xff, 0xd4, 0xfe, 0xb6, 0xff, 0x96, 0xff, 0x99, 0x00, 0x61, 0x01, 0xa0, 0xff,
        0x91, 0xfe, 0x33, 0xff, 0x8f, 0x01, 0xde, 0x01, 0xd3, 0xfe, 0x99, 0xfe, 0x67, 0x00, 0x44, 0x00, 0xe2, 0xfe, 0x59, 0xff,
        0x1b, 0x02, 0xc7, 0x01, 0x90, 0xff, 0xa6, 0xff, 0x84, 0xff, 0x04, 0xff, 0x01, 0xff, 0x3d, 0xff, 0x50, 0x00, 0x2d, 0x01,
        0xce, 0x00, 0x42, 0xff, 0x51, 0xff, 0xa9, 0x01, 0xaa, 0x01, 0x21, 0xff, 0x92, 0xfe, 0x8d, 0x00, 0xcb, 0x00, 0x43, 0xfe,
        0x91, 0xfd, 0x43, 0x00, 0xee, 0x01, 0xb1, 0xff, 0x48, 0xff, 0x39, 0x03, 0x0f, 0x03, 0x95, 0xfe, 0x7a, 0xfd, 0x98, 0xff,
        0x53, 0x00, 0x8c, 0xfe, 0xb4, 0xfe, 0x2a, 0x01, 0xc2, 0x00, 0x0c, 0xff, 0xc8, 0xff, 0x6e, 0x01, 0x12, 0x02, 0x22, 0x01,
        0x99, 0xfe, 0x3e, 0xfe, 0xaa, 0x00, 0x8d, 0xff, 0x65, 0xfe, 0xa7, 0x00, 0x59, 0xff, 0x16, 0xff, 0x7f, 0x02, 0x77, 0x00,
        0x84, 0xfd, 0x94, 0x00, 0xe9, 0x02, 0xeb, 0xff, 0x97, 0xfd, 0x24, 0x00, 0x2f, 0x01, 0x8b, 0xfe, 0xfc, 0xfe, 0x74, 0x01,
        0xf1, 0x00, 0xa3, 0xff, 0x00, 0xff, 0xe6, 0xff, 0xa7, 0x01, 0xc9, 0xff, 0x2e, 0xff, 0x4b, 0x00, 0xef, 0xfe, 0x1d, 0xff,
        0x38, 0x01, 0x40, 0x13, 0x09, 0x17, 0x33, 0xdc, 0x81, 0xc8, 0xa3, 0x12, 0x49, 0x2e, 0x98, 0x07, 0x0c, 0xf9, 0xf2, 0xf7,
        0x20, 0xf4, 0x44, 0xf6, 0xea, 0xf7, 0x6a, 0xf7, 0xbb, 0xfb, 0x16, 0x11, 0xf2, 0x1c, 0xd5, 0x0b, 0x9a, 0x03, 0xb8, 0x0e,
        0x1c, 0x0c, 0xe7, 0xed, 0xc4, 0xd8, 0x81, 0xea, 0x48, 0xf8, 0x73, 0xee, 0x0d, 0xfa, 0xa2, 0x19, 0x32, 0x22, 0x2e, 0x15,
        0x9c, 0x0d, 0xf8, 0x0a, 0x8d, 0xff, 0x67, 0xeb, 0xc7, 0xdf, 0xdf, 0xea, 0x70, 0xf8, 0x2f, 0xf7, 0xac, 0xfb, 0x07, 0x12,
        0x40, 0x24, 0x1e, 0x1a, 0x21, 0x04, 0x97, 0x00, 0x6e, 0x00, 0xa0, 0xed, 0x8a, 0xdb, 0x3e, 0xe4, 0xd2, 0xfb, 0x04, 0x05,
        0xaa, 0x07, 0xc6, 0x17, 0x40, 0x24, 0x4b, 0x16, 0xe2, 0xfc, 0x62, 0xf6, 0xef, 0xf9, 0x4c, 0xec, 0x67, 0xdc, 0x18, 0xe8,
        0x32, 0x05, 0xa1, 0x12, 0xfb, 0x0d, 0xa9, 0x10, 0x70, 0x1a, 0x79, 0x11, 0x7d, 0xf6, 0x4a, 0xeb, 0x6e, 0xf4, 0x64, 0xf0,
        0x05, 0xe5, 0xeb, 0xf3, 0xa0, 0x0f, 0x18, 0x17, 0x05, 0x0e, 0x39, 0x0d, 0x0d, 0x14, 0x70, 0x07, 0xcb, 0xea, 0xfc, 0xe4,
        0xe1, 0xf5, 0x50, 0xf7, 0xf6, 0xed, 0x3a, 0xfc, 0x17, 0x1a, 0xc8, 0x21, 0x70, 0x0d, 0x04, 0x00, 0xa6, 0x06, 0xa9, 0x01,
        0x11, 0xe8, 0x44, 0xdc, 0xbb, 0xee, 0xba, 0x01, 0xb4, 0xff, 0x4f, 0x03, 0x36, 0x1a, 0x1f, 0x24, 0x69, 0x12, 0x2f, 0xff,
        0x26, 0xfc, 0x8b, 0xf6, 0x1b, 0xe2, 0x6d, 0xda, 0x45, 0xef, 0x09, 0x06, 0x88, 0x0a, 0x90, 0x0c, 0xb9, 0x1a, 0xe1, 0x20,
        0xd7, 0x0d, 0x97, 0xf7, 0x35, 0xf3, 0xbb, 0xf1, 0xe9, 0xe4, 0x89, 0xe0, 0x98, 0xf5, 0xc1, 0x0e, 0x7e, 0x13, 0x17, 0x10,
        0x29, 0x18, 0xf1, 0x1a, 0x8c, 0x05, 0x81, 0xee, 0xce, 0xea, 0xce, 0xec, 0x94, 0xe9, 0x02, 0xed, 0xe9, 0xff, 0xf2, 0x12,
        0x71, 0x14, 0x45, 0x0f, 0xe5, 0x12, 0x73, 0x11, 0x17, 0xfd, 0xd6, 0xe8, 0x89, 0xe8, 0x67, 0xf1, 0x08, 0xf4, 0x03, 0xf6,
        0x1f, 0x04, 0x41, 0x1a, 0xc1, 0x1f, 0xc4, 0x0c, 0xe5, 0xff, 0xc6, 0x04, 0x43, 0xfb, 0x86, 0xe1, 0xc0, 0xdf, 0x07, 0xf6,
        0xeb, 0xff, 0x3f, 0xff, 0xd4, 0x0c, 0x2e, 0x20, 0xb4, 0x1f, 0x95, 0x0a, 0x30, 0xf9, 0x9c, 0xf7, 0x41, 0xf4, 0x52, 0xe6,
        0x43, 0xe2, 0x88, 0xf2, 0x61, 0x04, 0x6b, 0x0b, 0x49, 0x12, 0xad, 0x1c, 0xcd, 0x1b, 0x0c, 0x09, 0x7d, 0xf5, 0x92, 0xf0,
        0x28, 0xee, 0xc2, 0xe4, 0x38, 0xe6, 0x45, 0xfa, 0x74, 0x0e, 0x98, 0x14, 0xd2, 0x13, 0xf4, 0x16, 0x34, 0x14, 0xd3, 0x00,
        0xaa, 0xed, 0xee, 0xea, 0x7d, 0xed, 0xc5, 0xea, 0xb6, 0xee, 0xd8, 0x02, 0x8f, 0x17, 0x32, 0x1a, 0xfd, 0x12, 0x1d, 0x12,
        0x8f, 0x0c, 0xaf, 0xf6, 0xcf, 0xe3, 0xdf, 0xe4, 0x5d, 0xee, 0x40, 0xf1, 0xc5, 0xf6, 0x7a, 0x0b, 0x6d, 0x1e, 0x93, 0x1c,
        0xd2, 0x10, 0x49, 0x0b, 0x24, 0x06, 0x73, 0xf3, 0xb0, 0xde, 0xed, 0xe0, 0x22, 0xf2, 0x84, 0xf9, 0xee, 0xfd, 0xd8, 0x10,
        0x93, 0x22, 0x4b, 0x1b, 0x53, 0x07, 0x86, 0x01, 0x1a, 0x02, 0x31, 0xf1, 0x14, 0xdc, 0x85, 0xe1, 0x09, 0xfa, 0xb8, 0x06,
        0x2c, 0x07, 0xb0, 0x11, 0x5b, 0x21, 0x73, 0x1a, 0x5a, 0x01, 0x55, 0xf4, 0x7b, 0xf4, 0x63, 0xec, 0xa9, 0xdf, 0x7d, 0xe8,
        0x2e, 0x03, 0x61, 0x10, 0xce, 0x0d, 0xa3, 0x13, 0xef, 0x1f, 0x46, 0x17, 0xe6, 0xf9, 0x93, 0xe8, 0x81, 0xec, 0x11, 0xed,
        0x2d, 0xe5, 0xe1, 0xec, 0x84, 0x08, 0x22, 0x1a, 0x67, 0x15, 0xde, 0x11, 0x41, 0x17, 0x42, 0x0f, 0xc4, 0xf4, 0x2c, 0xe3,
        0x05, 0xe8, 0xf6, 0xef, 0xa3, 0xee, 0x39, 0xf5, 0x3c, 0x0d, 0xaa, 0x1f, 0x82, 0x1a, 0x13, 0x0e, 0xc3, 0x0b, 0x47, 0x05,
        0x67, 0xef, 0xac, 0xde, 0xce, 0xe5, 0xa1, 0xf5, 0xb7, 0xf9, 0x2e, 0xfe, 0x76, 0x11, 0x05, 0x22, 0x06, 0x1b, 0x73, 0x07,
        0xf0, 0xfe, 0x11, 0xfd, 0xde, 0xee, 0xe5, 0xdf, 0xb3, 0xe6, 0x26, 0xfa, 0xb8, 0x04, 0x27, 0x08, 0x06, 0x13, 0xc9, 0x1e,
        0x13, 0x17, 0xc0, 0x00, 0xbe, 0xf4, 0x9c, 0xf4, 0x8f, 0xee, 0xf7, 0xe3, 0x68, 0xea, 0x93, 0x02, 0x6b, 0x10, 0xca, 0x0e,
        0x28, 0x12, 0xf1, 0x19, 0xac, 0x11, 0x08, 0xfa, 0xe6, 0xeb, 0x56, 0xee, 0xc4, 0xee, 0x01, 0xe9, 0x97, 0xf0, 0x72, 0x08,
        0x6e, 0x18, 0xbc, 0x14, 0x89, 0x0f, 0x3b, 0x12, 0x39, 0x0b, 0x42, 0xf5, 0xd1, 0xe6, 0x45, 0xeb, 0x6b, 0xf1, 0x93, 0xf0,
        0xe8, 0xf7, 0x93, 0x0d, 0x02, 0x1c, 0x62, 0x15, 0x53, 0x0b, 0x6c, 0x0a, 0xb1, 0x03, 0xe5, 0xee, 0xf8, 0xe1, 0x5f, 0xeb,
        0x4f, 0xf9, 0xe2, 0xfb, 0x6a, 0x00, 0xbf, 0x11, 0xd2, 0x1d, 0x18, 0x15, 0x2b, 0x05, 0xad, 0xff, 0xbe, 0xfa, 0x64, 0xeb,
        0x75, 0xe1, 0xc0, 0xec, 0x2b, 0xff, 0xe1, 0x04, 0x03, 0x08, 0xec, 0x15, 0xa8, 0x1e, 0xc9, 0x10, 0x3b, 0xfc, 0x4f, 0xf6,
        0xee, 0xf5, 0xcc, 0xeb, 0x65, 0xe3, 0xbe, 0xef, 0xaa, 0x05, 0x06, 0x0e, 0xdc, 0x0d, 0xf9, 0x14, 0xb9, 0x19, 0x82, 0x0b,
        0x4d, 0xf5, 0xca, 0xed, 0x4e, 0xf1, 0xbe, 0xed, 0xc0, 0xe9, 0xbe, 0xf7, 0x9f, 0x0e, 0xfb, 0x15, 0xd0, 0x0f, 0x8d, 0x0f,
        0x8f, 0x12, 0xa0, 0x05, 0xf1, 0xed, 0x49, 0xe6, 0x2f, 0xef, 0xc8, 0xf2, 0x12, 0xf2, 0xf6, 0xfe, 0xaf, 0x14, 0x40, 0x1b,
        0xf2, 0x10, 0x2e, 0x0a, 0x5e, 0x09, 0x04, 0xfe, 0x30, 0xe9, 0xb5, 0xe2, 0x82, 0xef, 0xc1, 0xf9, 0x1a, 0xfb, 0x9d, 0x04,
        0x6e, 0x18, 0x6d, 0x1e, 0x55, 0x0f, 0xdc, 0x01, 0x10, 0x00, 0x94, 0xf8, 0xe1, 0xe6, 0x4d, 0xe2, 0x52, 0xf2, 0xbc, 0x01,
        0x91, 0x05, 0x64, 0x0b, 0xf1, 0x18, 0x0d, 0x1c, 0xfd, 0x0a, 0xfe, 0xf8, 0x3b, 0xf5, 0xcd, 0xf2, 0x1c, 0xe8, 0x42, 0xe5,
        0x36, 0xf7, 0xe1, 0x0b, 0x9f, 0x0f, 0xca, 0x0e, 0x50, 0x17, 0xa8, 0x18, 0x1c, 0x05, 0x32, 0xf0, 0x69, 0xec, 0x41, 0xef,
        0x3a, 0xeb, 0x76, 0xeb, 0xf6, 0xfd, 0x6e, 0x13, 0xc2, 0x16, 0xa4, 0x10, 0xba, 0x11, 0xc3, 0x10, 0xfd, 0xfe, 0xc0, 0xe9,
        0xf8, 0xe6, 0x8d, 0xef, 0x24, 0xf1, 0x38, 0xf3, 0x8f, 0x04, 0x68, 0x18, 0x27, 0x1a, 0xd5, 0x0f, 0xf1, 0x0a, 0x0f, 0x08,
        0xe1, 0xf8, 0xea, 0xe5, 0x9d, 0xe4, 0xb0, 0xf1, 0xad, 0xf9, 0xf2, 0xfc, 0xe2, 0x09, 0xf9, 0x1a, 0x82, 0x1b, 0x96, 0x0c,
        0x4a, 0x02, 0x66, 0xfe, 0x0b, 0xf3, 0x88, 0xe4, 0xa7, 0xe5, 0xfe, 0xf5, 0x75, 0x02, 0x34, 0x06, 0xb7, 0x0e, 0x2a, 0x1b,
        0x0a, 0x19, 0x03, 0x07, 0x78, 0xf8, 0xed, 0xf4, 0xda, 0xef, 0x55, 0xe6, 0x17, 0xe9, 0x0f, 0xfc, 0xa1, 0x0b, 0x8f, 0x0e,
        0x6b, 0x11, 0x28, 0x18, 0x63, 0x14, 0x4b, 0x01, 0x3d, 0xf0, 0x64, 0xed, 0xda, 0xed, 0x0a, 0xea, 0xde, 0xee, 0x73, 0x02,
        0xd4, 0x13, 0x44, 0x15, 0x39, 0x11, 0xcd, 0x12, 0x10, 0x0e, 0x1b, 0xfa, 0xbb, 0xe8, 0x72, 0xe9, 0xf4, 0xef, 0xc9, 0xf0,
        0xdf, 0xf6, 0x30, 0x09, 0xf2, 0x18, 0x06, 0x18, 0xf1, 0x0e, 0x65, 0x0a, 0x60, 0x04, 0xe5, 0xf3, 0xdc, 0xe4, 0x65, 0xe7,
        0xb0, 0xf3, 0x5e, 0xfa, 0xa4, 0xff, 0x62, 0x0e, 0x8d, 0x1c, 0x81, 0x18, 0x56, 0x09, 0x18, 0x01, 0x3e, 0xfc, 0x1f, 0xef,
        0xea, 0xe2, 0x2d, 0xe8, 0x99, 0xf9, 0x52, 0x04, 0x53, 0x08, 0x9d, 0x12, 0x7c, 0x1c, 0x59, 0x15, 0xcb, 0x02, 0x27, 0xf7,
        0x02, 0xf4, 0x94, 0xed, 0x4e, 0xe5, 0xf3, 0xeb, 0xac, 0x00, 0x5a, 0x0d, 0x22, 0x0e, 0xc8, 0x12, 0x9d, 0x19, 0x11, 0x11,
        0x9d, 0xfb, 0x1f, 0xef, 0xaa, 0xef, 0xb4, 0xed, 0x36, 0xe9, 0x59, 0xf2, 0x4e, 0x07, 0xf0, 0x13, 0xd5, 0x12, 0x38, 0x11,
        0x97, 0x12, 0xbb, 0x09, 0x72, 0xf5, 0x06, 0xe9, 0x4d, 0xec, 0x3f, 0xf1, 0x5b, 0xf1, 0x70, 0xf9, 0x46, 0x0d, 0xf4, 0x19,
        0x62, 0x14, 0xa9, 0x0b, 0x84, 0x0a, 0x0e, 0x03, 0xc4, 0xef, 0x33, 0xe5, 0x75, 0xec, 0x8b, 0xf5, 0x0a, 0xf9, 0xa1, 0x01,
        0x4f, 0x12, 0xd0, 0x1b, 0xd4, 0x13, 0xb2, 0x06, 0x60, 0x01, 0x22, 0xfb, 0x8a, 0xec, 0x3d, 0xe4, 0xad, 0xed, 0x84, 0xfc,
        0xde, 0x02, 0x46, 0x08, 0xf1, 0x14, 0x72, 0x1b, 0x60, 0x10, 0xd5, 0xff, 0xc2, 0xf7, 0xba, 0xf3, 0xc0, 0xeb, 0xa5, 0xe7,
        0xba, 0xf2, 0x4a, 0x03, 0xb2, 0x0a, 0x32, 0x0e, 0xf7, 0x14, 0x9e, 0x16, 0x2b, 0x0b, 0x5f, 0xf9, 0x9e, 0xee, 0x55, 0xee,
        0x9f, 0xee, 0x92, 0xed, 0x2f, 0xf7, 0x4c, 0x0a, 0xa2, 0x14, 0xd9, 0x11, 0xea, 0x0f, 0x4c, 0x10, 0x7f, 0x05, 0x9c, 0xf1,
        0xfc, 0xe7, 0xf3, 0xec, 0x0f, 0xf2, 0x37, 0xf4, 0xa0, 0xff, 0x29, 0x12, 0x4f, 0x19, 0xbe, 0x11, 0x54, 0x0a, 0x90, 0x07,
        0xb7, 0xfd, 0x5c, 0xec, 0x2d, 0xe5, 0x44, 0xee, 0x14, 0xf9, 0xcc, 0xfd, 0x29, 0x06, 0xfe, 0x14, 0x24, 0x1b, 0x94, 0x10,
        0x4f, 0x03, 0x93, 0xfd, 0x06, 0xf6, 0x82, 0xe9, 0x0a, 0xe6, 0x8c, 0xf1, 0x1e, 0x00, 0x0a, 0x07, 0xaf, 0x0b, 0x21, 0x16,
        0xe2, 0x1a, 0xc4, 0x0c, 0x6b, 0xfa, 0xcc, 0xf4, 0xcd, 0xf1, 0x48, 0xe9, 0x97, 0xe8, 0xff, 0xf6, 0x25, 0x08, 0x99, 0x0f,
        0x46, 0x10, 0xa1, 0x13, 0x80, 0x14, 0xbd, 0x06, 0xeb, 0xf3, 0x97, 0xed, 0x9e, 0xef, 0xb9, 0xed, 0x3d, 0xee, 0x2d, 0xfd,
        0xf4, 0x0f, 0xc4, 0x14, 0x99, 0x10, 0xfc, 0x0f, 0x6f, 0x0d, 0x2b, 0x00, 0x4c, 0xee, 0x9f, 0xe7, 0x5c, 0xef, 0x1a, 0xf4,
        0xcf, 0xf4, 0x33, 0x03, 0x2b, 0x16, 0x0b, 0x18, 0xc6, 0x0f, 0xee, 0x0a, 0x33, 0x05, 0x7b, 0xf8, 0x04, 0xea, 0xf6, 0xe6,
        0x99, 0xf0, 0xab, 0xf9, 0x2b, 0xff, 0x87, 0x09, 0x30, 0x17, 0x83, 0x19, 0xed, 0x0c, 0x3f, 0x01, 0x33, 0xfd, 0x01, 0xf5,
        0x5f, 0xe8, 0xe6, 0xe7, 0x34, 0xf5, 0x75, 0x01, 0xe3, 0x06, 0xa2, 0x0d, 0x8d, 0x17, 0x9b, 0x16, 0xf8, 0x07, 0x13, 0xfb,
        0xd1, 0xf5, 0xf9, 0xef, 0x44, 0xe9, 0xf9, 0xeb, 0xd0, 0xf9, 0xb2, 0x08, 0x75, 0x0f, 0xde, 0x10, 0x9d, 0x13, 0x05, 0x12,
        0xae, 0x03, 0xbc, 0xf2, 0xe9, 0xed, 0x76, 0xef, 0xd8, 0xed, 0xd3, 0xf0, 0x32, 0x00, 0x6d, 0x10, 0x3a, 0x14, 0x91, 0x10,
        0x74, 0x0f, 0xd1, 0x0b, 0xb9, 0xfc, 0x4d, 0xec, 0xaa, 0xe9, 0x60, 0xf0, 0xa2, 0xf3, 0xdd, 0xf7, 0xcd, 0x06, 0x0e, 0x16,
        0xfe, 0x16, 0x7a, 0x0e, 0xfd, 0x08, 0xc8, 0x03, 0x98, 0xf6, 0x2f, 0xe9, 0xa4, 0xe8, 0xe8, 0xf1, 0x29, 0xfa, 0x3d, 0x01,
        0xa7, 0x0c, 0x66, 0x18, 0xba, 0x17, 0x9d, 0x0a, 0x2c, 0x00, 0x55, 0xfb, 0x27, 0xf2, 0x72, 0xe7, 0xe1, 0xe8, 0x6c, 0xf7,
        0x46, 0x04, 0xd8, 0x08, 0x77, 0x0f, 0x49, 0x18, 0x0a, 0x15, 0x89, 0x05, 0x2d, 0xf8, 0xeb, 0xf2, 0xd7, 0xee, 0x82, 0xe9,
        0xa3, 0xed, 0x72, 0xfe, 0x09, 0x0c, 0x14, 0x0f, 0x97, 0x11, 0x9a, 0x15, 0x7e, 0x10, 0x0f, 0xfe, 0x75, 0xed, 0x76, 0xec,
        0x5a, 0xf0, 0xef, 0xee, 0x46, 0xf4, 0xfb, 0x05, 0x35, 0x13, 0x6e, 0x12, 0xfa, 0x0e, 0x85, 0x0f, 0xc3, 0x08, 0x7e, 0xf7,
        0x6b, 0xeb, 0x58, 0xec, 0x64, 0xf1, 0x1e, 0xf4, 0xfd, 0xfa, 0x7d, 0x0a, 0xf8, 0x16, 0xbb, 0x14, 0x9c, 0x0b, 0x0a, 0x07,
        0x49, 0x01, 0x64, 0xf3, 0x49, 0xe8, 0x20, 0xec, 0xee, 0xf6, 0xda, 0xfc, 0x49, 0x02, 0x3a, 0x0e, 0x03, 0x18, 0xec, 0x13,
        0x6e, 0x07, 0x09, 0xff, 0xb1, 0xf9, 0x73, 0xef, 0x6e, 0xe7, 0xc4, 0xed, 0x9a, 0xfc, 0x68, 0x05, 0x3e, 0x08, 0x34, 0x10,
        0x07, 0x18, 0xed, 0x10, 0xd7, 0x00, 0xab, 0xf7, 0x7e, 0xf4, 0x99, 0xee, 0x6b, 0xea, 0x2d, 0xf2, 0xcd, 0x01, 0xa2, 0x0b,
        0x75, 0x0d, 0x2c, 0x10, 0x71, 0x13, 0xd9, 0x0b, 0xca, 0xfa, 0xc3, 0xf0, 0x86, 0xf1, 0x17, 0xf1, 0x2b, 0xef, 0x46, 0xf7,
        0x3a, 0x07, 0xfb, 0x10, 0xf5, 0x10, 0x1c, 0x0f, 0x9c, 0x0d, 0x52, 0x05, 0x58, 0xf5, 0x5b, 0xeb, 0x92, 0xee, 0x0b, 0xf4,
        0xce, 0xf5, 0x46, 0xfd, 0x13, 0x0d, 0x63, 0x16, 0xf4, 0x11, 0x58, 0x0a, 0x53, 0x06, 0x18, 0xff, 0x50, 0xf1, 0x9d, 0xe8,
        0xd6, 0xed, 0x1f, 0xf8, 0x46, 0xfd, 0xb9, 0x03, 0x01, 0x11, 0x84, 0x18, 0xcb, 0x10, 0xd5, 0x04, 0x01, 0xff, 0xc2, 0xf8,
        0x6b, 0xed, 0x9e, 0xe7, 0xa3, 0xf0, 0xfb, 0xfe, 0xe7, 0x05, 0x0a, 0x0a, 0x81, 0x12, 0xbb, 0x16, 0x27, 0x0d, 0x11, 0xfe,
        0xaa, 0xf6, 0xc2, 0xf3, 0x4c, 0xed, 0x9c, 0xea, 0x63, 0xf5, 0xa5, 0x05, 0x05, 0x0d, 0x02, 0x0e, 0x06, 0x12, 0xf3, 0x12,
        0x7f, 0x07, 0x75, 0xf7, 0x13, 0xf0, 0x25, 0xf0, 0x7f, 0xef, 0x71, 0xf0, 0x69, 0xfb, 0xb1, 0x0b, 0xfa, 0x12, 0x0c, 0x10,
        0xbe, 0x0d, 0xbf, 0x0c, 0x1f, 0x02, 0x15, 0xf1, 0x58, 0xea, 0xa6, 0xef, 0x21, 0xf4, 0x00, 0xf7, 0x61, 0x02, 0x6d, 0x11,
        0x25, 0x16, 0xab, 0x0f, 0x3a, 0x09, 0xa7, 0x05, 0x89, 0xfb, 0x14, 0xed, 0x85, 0xe8, 0x84, 0xf0, 0x91, 0xf9, 0xe2, 0xfe,
        0xe9, 0x07, 0x1d, 0x14, 0x18, 0x17, 0x3c, 0x0d, 0x60, 0x02, 0x4b, 0xfd, 0x94, 0xf6, 0xfb, 0xeb, 0x8d, 0xe9, 0x8f, 0xf4,
        0xe5, 0x00, 0x77, 0x06, 0x95, 0x0b, 0xca, 0x13, 0x1d, 0x15, 0x62, 0x09, 0x7a, 0xfb, 0xa7, 0xf5, 0xa2, 0xf2, 0x96, 0xec,
        0x78, 0xec, 0x89, 0xf9, 0xb6, 0x08, 0xa2, 0x0d, 0xfc, 0x0d, 0x07, 0x12, 0x86, 0x11, 0x08, 0x04, 0x3d, 0xf4, 0x8b, 0xef,
        0xd7, 0xf0, 0x64, 0xef, 0x45, 0xf1, 0x15, 0xff, 0x53, 0x0f, 0x08, 0x13, 0xf3, 0x0e, 0x3b, 0x0e, 0xb6, 0x0b, 0xee, 0xfd,
        0xec, 0xed, 0xf6, 0xea, 0x58, 0xf1, 0x9a, 0xf4, 0x15, 0xf8, 0x5c, 0x05, 0x1d, 0x14, 0xbc, 0x15, 0x97, 0x0d, 0x27, 0x08,
        0xe4, 0x03, 0x06, 0xf8, 0x55, 0xea, 0x91, 0xe9, 0x28, 0xf4, 0xab, 0xfb, 0xdb, 0xff, 0x37, 0x0a, 0xc9, 0x16, 0xe0, 0x16,
        0xfb, 0x09, 0xc6, 0xff, 0xee, 0xfb, 0xda, 0xf3, 0x4f, 0xe9, 0x70, 0xea, 0x48, 0xf8, 0xd5, 0x03, 0x77, 0x07, 0xd5, 0x0d,
        0x09, 0x17, 0x4c, 0x14, 0x64, 0x04, 0xdf, 0xf7, 0x22, 0xf5, 0x47, 0xf1, 0x64, 0xea, 0xf1, 0xed, 0x8e, 0xfe, 0xe5, 0x0b,
        0xbf, 0x0d, 0xed, 0x0e, 0x92, 0x13, 0x84, 0x0f, 0xd2, 0xfe, 0xd9, 0xf0, 0x83, 0xef, 0xd7, 0xf0, 0xcb, 0xee, 0x96, 0xf3,
        0xeb, 0x03, 0x54, 0x12, 0xb5, 0x12, 0xed, 0x0d, 0x25, 0x0e, 0x6b, 0x09, 0xdc, 0xf8, 0x71, 0xeb, 0xf3, 0xec, 0x5b, 0xf3,
        0xe7, 0xf4, 0xf8, 0xf9, 0x72, 0x09, 0x74, 0x16, 0x44, 0x14, 0x0d, 0x0b, 0xbc, 0x06, 0x27, 0x02, 0x0e, 0xf5, 0x8f, 0xe8,
        0xff, 0xea, 0x09, 0xf7, 0x51, 0xfd, 0xfe, 0x00, 0x13, 0x0d, 0x9d, 0x18, 0x2d, 0x14, 0x76, 0x06, 0x01, 0xff, 0x41, 0xfb,
        0x0f, 0xf1, 0x4b, 0xe7, 0x12, 0xed, 0xef, 0xfc, 0x37, 0x05, 0x5b, 0x07, 0x88, 0x0f, 0xda, 0x17, 0x97, 0x11, 0xd3, 0x00,
        0xb1, 0xf6, 0xfb, 0xf4, 0x10, 0xf0, 0x2b, 0xea, 0xb9, 0xf0, 0xe9, 0x01, 0xeb, 0x0c, 0xae, 0x0d, 0xa9, 0x0f, 0xd6, 0x13,
        0x00, 0x0d, 0xd8, 0xfa, 0x7b, 0xef, 0x9f, 0xf0, 0x21, 0xf1, 0x45, 0xee, 0x02, 0xf6, 0x8d, 0x08, 0x53, 0x13, 0xc6, 0x10,
        0xb7, 0x0d, 0x36, 0x0e, 0x1b, 0x07, 0xc6, 0xf5, 0xbb, 0xe9, 0x09, 0xed, 0xff, 0xf3, 0xc9, 0xf5, 0x96, 0xfc, 0xfe, 0x0c,
        0xe3, 0x17, 0xda, 0x12, 0xb6, 0x09, 0xb5, 0x06, 0x52, 0x00, 0x81, 0xf0, 0x9f, 0xe6, 0xa7, 0xed, 0x1e, 0xf9, 0x66, 0xfd,
        0xdf, 0x02, 0x07, 0x11, 0x36, 0x1a, 0xea, 0x11, 0xd9, 0x03, 0x00, 0xfe, 0x85, 0xf9, 0x09, 0xee, 0xd5, 0xe6, 0xa6, 0xef,
        0xa8, 0xfe, 0xea, 0x05, 0xa8, 0x09, 0xb7, 0x12, 0x4a, 0x18, 0x44, 0x0e, 0xa3, 0xfd, 0xbb, 0xf5, 0x00, 0xf4, 0x05, 0xee,
        0x7c, 0xe9, 0x4d, 0xf3, 0x82, 0x05, 0x73, 0x0e, 0x00, 0x0e, 0x3b, 0x11, 0x7d, 0x14, 0xdb, 0x09, 0xd5, 0xf6, 0xa6, 0xee,
        0xf9, 0xf0, 0xa6, 0xef, 0x41, 0xee, 0x60, 0xf9, 0xe6, 0x0b, 0x8a, 0x14, 0xca, 0x10, 0x00, 0x0e, 0xea, 0x0d, 0x5f, 0x03,
        0x07, 0xf1, 0x9c, 0xe9, 0x74, 0xef, 0xfe, 0xf3, 0x36, 0xf5, 0x8f, 0xff, 0x7f, 0x11, 0xf0, 0x18, 0x03, 0x11, 0xfd, 0x08,
        0xf7, 0x05, 0x6f, 0xfc, 0x67, 0xec, 0xff, 0xe6, 0xf7, 0xf0, 0x16, 0xfa, 0x44, 0xfd, 0x2a, 0x06, 0xa7, 0x14, 0x3b, 0x19,
        0x06, 0x0f, 0xf3, 0x02, 0x66, 0xfd, 0x89, 0xf6, 0x81, 0xea, 0xf2, 0xe6, 0x31, 0xf3, 0x95, 0x01, 0x0e, 0x07, 0xbf, 0x0b,
        0x7d, 0x15, 0xa5, 0x17, 0xee, 0x09, 0x5e, 0xfa, 0x25, 0xf5, 0x71, 0xf2, 0x66, 0xeb, 0xac, 0xea, 0x07, 0xf9, 0xa9, 0x09,
        0xae, 0x0e, 0x71, 0x0e, 0xf8, 0x12, 0xb9, 0x12, 0x8b, 0x03, 0xc6, 0xf2, 0x85, 0xee, 0x92, 0xf0, 0xfd, 0xee, 0xd9, 0xf0,
        0x71, 0xff, 0x53, 0x10, 0xf6, 0x13, 0x3a, 0x0f, 0x55, 0x0e, 0xcd, 0x0b, 0xb6, 0xfd, 0x03, 0xed, 0x11, 0xea, 0x4c, 0xf1,
        0x0b, 0xf5, 0xe1, 0xf7, 0x69, 0x05, 0x26, 0x15, 0x33, 0x16, 0x9e, 0x0d, 0x0f, 0x08, 0x10, 0x04, 0x40, 0xf8, 0xf2, 0xe9,
        0xd1, 0xe8, 0xf3, 0xf3, 0xf2, 0xfb, 0xb3, 0xff, 0xad, 0x09, 0x5a, 0x16, 0x60, 0x17, 0x64, 0x0a, 0x43, 0x00, 0x02, 0xfd,
        0x39, 0xf4, 0x8f, 0xe8, 0x65, 0xe9, 0xc8, 0xf7, 0x6b, 0x03, 0xe1, 0x06, 0xad, 0x0d, 0xea, 0x17, 0x55, 0x15, 0x83, 0x05,
        0x69, 0xf8, 0xc2, 0xf4, 0x2d, 0xf1, 0xcd, 0xe9, 0xdd, 0xec, 0x24, 0xfd, 0xb2, 0x0a, 0xe8, 0x0d, 0x7c, 0x0f, 0xd7, 0x14,
        0xf4, 0x11, 0xf7, 0xff, 0xa9, 0xf0, 0x84, 0xef, 0xb9, 0xf0, 0x0f, 0xed, 0x11, 0xf2, 0xd2, 0x03, 0xf0, 0x10, 0x20, 0x12,
        0x09, 0x0f, 0xbe, 0x0f, 0x2f, 0x0b, 0x46, 0xfa, 0xab, 0xeb, 0x9f, 0xeb, 0x33, 0xf2, 0x9c, 0xf3, 0xfc, 0xf8, 0x1e, 0x09,
        0x30, 0x16, 0xe2, 0x13, 0x1f, 0x0c, 0xff, 0x08, 0x5d, 0x03, 0x92, 0xf5, 0x4f, 0xe8, 0xb9, 0xea, 0xc6, 0xf5, 0x23, 0xfb,
        0x23, 0x00, 0x1e, 0x0d, 0x05, 0x19, 0x09, 0x15, 0x7c, 0x07, 0x99, 0x00, 0xf2, 0xfb, 0x6e, 0xf0, 0xe5, 0xe7, 0xa1, 0xec,
        0xb3, 0xfa, 0xb7, 0x03, 0xe9, 0x06, 0xe9, 0x0f, 0x56, 0x18, 0x2b, 0x12, 0x48, 0x02, 0x6e, 0xf8, 0xac, 0xf5, 0xec, 0xef,
        0x5b, 0xe9, 0xd7, 0xee, 0x48, 0x00, 0x97, 0x0c, 0xc6, 0x0c, 0x40, 0x10, 0xb3, 0x15, 0xa9, 0x0c, 0x82, 0xfb, 0x71, 0xf1,
        0x2f, 0xf1, 0x60, 0xf0, 0x91, 0xed, 0xeb, 0xf4, 0xf1, 0x06, 0xa2, 0x12, 0x40, 0x11, 0xd3, 0x0e, 0x02, 0x0f, 0x9c, 0x07,
        0x81, 0xf5, 0x0f, 0xea, 0xf0, 0xed, 0xea, 0xf3, 0xf1, 0xf4, 0xb7, 0xfb, 0x82, 0x0d, 0x5a, 0x17, 0x6c, 0x11, 0x83, 0x0a,
        0x56, 0x07, 0xd1, 0xff, 0xfe, 0xf0, 0x13, 0xe8, 0x79, 0xee, 0x99, 0xf8, 0x49, 0xfd, 0x4e, 0x02, 0x66, 0x0f, 0xf8, 0x18,
        0xca, 0x10, 0x1c, 0x04, 0xf6, 0xff, 0xac, 0xfb, 0x56, 0xef, 0x3e, 0xe7, 0xfb, 0xee, 0xd1, 0xfd, 0x97, 0x04, 0x8c, 0x07,
        0xab, 0x12, 0xaa, 0x18, 0xd4, 0x0d, 0x2c, 0xfe, 0x21, 0xf8, 0xb7, 0xf5, 0x44, 0xed, 0xb1, 0xe9, 0xa7, 0xf3, 0xd3, 0x03,
        0xf1, 0x0c, 0x0d, 0x0d, 0x7e, 0x10, 0x67, 0x15, 0xde, 0x0a, 0x0b, 0xf8, 0x34, 0xf0, 0xb9, 0xf1, 0x72, 0xef, 0xc1, 0xeb,
        0x61, 0xf8, 0xdb, 0x0b, 0x2c, 0x12, 0x90, 0x10, 0xad, 0x10, 0x5c, 0x0f, 0xc3, 0x03, 0xe2, 0xf1, 0x06, 0xea, 0x2a, 0xef,
        0xd9, 0xf2, 0x3e, 0xf4, 0x32, 0xff, 0x62, 0x10, 0x15, 0x18, 0x57, 0x11, 0x86, 0x09, 0xf1, 0x06, 0x86, 0xfd, 0x96, 0xed,
        0xd2, 0xe7, 0xc9, 0xf0, 0xe2, 0xf9, 0x9a, 0xfb, 0xda, 0x04, 0x4a, 0x14, 0x35, 0x18, 0x2b, 0x0e, 0xcd, 0x03, 0xf7, 0xff,
        0xe6, 0xf7, 0x37, 0xec, 0x96, 0xe7, 0x7f, 0xf1, 0x7a, 0xff, 0x92, 0x04, 0xbc, 0x0a, 0xe2, 0x14, 0x30, 0x18, 0xe0, 0x0c,
        0x0e, 0xfd, 0x28, 0xf7, 0xe1, 0xf2, 0x4a, 0xe9, 0x69, 0xe8, 0x1c, 0xf7, 0x2b, 0x08, 0xa8, 0x0d, 0x70, 0x0e, 0x44, 0x14,
        0x9c, 0x13, 0x2c, 0x06, 0xa2, 0xf5, 0x43, 0xef, 0x3e, 0xf1, 0xad, 0xee, 0x89, 0xee, 0x5a, 0xfc, 0x39, 0x0c, 0x51, 0x11,
        0xe1, 0x10, 0xea, 0x10, 0xc1, 0x0e, 0x91, 0x01, 0x23, 0xef, 0x4f, 0xea, 0xd4, 0xf0, 0x57, 0xf1, 0x65, 0xf3, 0x3b, 0x03,
        0x3f, 0x13, 0xac, 0x18, 0xd4, 0x11, 0x8e, 0x09, 0x8e, 0x05, 0xb2, 0xf8, 0x20, 0xe9, 0x4e, 0xe8, 0x02, 0xf2, 0x54, 0xf9,
        0x60, 0xff, 0xf0, 0x0a, 0xbb, 0x16, 0xf5, 0x16, 0x35, 0x0c, 0x97, 0x00, 0x45, 0xfd, 0xa4, 0xf6, 0xd5, 0xe8, 0xf6, 0xe9,
        0xcf, 0xf5, 0x65, 0xff, 0xa3, 0x04, 0xd6, 0x0b, 0xac, 0x17, 0x51, 0x17, 0x8b, 0x0a, 0x4e, 0xfd, 0x2c, 0xf6, 0xb7, 0xf0,
        0x7c, 0xe7, 0x90, 0xe9, 0x12, 0xf9, 0x8c, 0x07, 0x7f, 0x0e, 0xbf, 0x11, 0x7c, 0x17, 0x48, 0x13, 0x30, 0x02, 0x65, 0xf2,
        0x50, 0xed, 0x57, 0xef, 0xce, 0xeb, 0x6c, 0xf1, 0x71, 0x04, 0x33, 0x10, 0x0b, 0x12, 0xb9, 0x0f, 0x5a, 0x0e, 0x3e, 0x0a,
        0xac, 0xfc, 0xaa, 0xee, 0xb4, 0xec, 0x84, 0xf1, 0x84, 0xf2, 0xec, 0xf6, 0xc4, 0x06, 0x08, 0x13, 0x5d, 0x14, 0x4e, 0x11,
        0x11, 0x0b, 0x12, 0x05, 0xfb, 0xf6, 0xf9, 0xe6, 0x14, 0xe9, 0x1e, 0xf3, 0xeb, 0xf7, 0x33, 0xff, 0x27, 0x0d, 0x97, 0x18,
        0x77, 0x18, 0xae, 0x0c, 0xe6, 0x01, 0x2d, 0xfb, 0x84, 0xef, 0x7d, 0xe6, 0x0f, 0xec, 0x3e, 0xf8, 0x35, 0x01, 0xf9, 0x07,
        0x68, 0x0f, 0xa8, 0x17, 0xdb, 0x13, 0xd1, 0x04, 0x3d, 0xfb, 0x03, 0xf7, 0x1c, 0xf0, 0x31, 0xe8, 0x9a, 0xec, 0xe5, 0xfc,
        0x29, 0x08, 0xa3, 0x0d, 0x7c, 0x13, 0x82, 0x16, 0x2c, 0x10, 0x2a, 0xfe, 0x3d, 0xf2, 0xe6, 0xef, 0xfd, 0xeb, 0x28, 0xec,
        0xb2, 0xf4, 0xec, 0x05, 0x01, 0x12, 0xb4, 0x12, 0x45, 0x11, 0xc6, 0x0f, 0x46, 0x08, 0x66, 0xf6, 0xff, 0xea, 0xa5, 0xec,
        0xba, 0xf0, 0x21, 0xf4, 0x93, 0xfc, 0x32, 0x0c, 0x08, 0x15, 0x06, 0x12, 0x80, 0x0d, 0xe8, 0x09, 0x87, 0x01, 0x92, 0xf2,
        0x68, 0xe8, 0xb9, 0xec, 0xc1, 0xf4, 0x8e, 0xf9, 0x15, 0x02, 0x3f, 0x0f, 0xa2, 0x17,
        };
        id(announcement_spk_resampler).play(NOTIFICATION_PCM, sizeof(NOTIFICATION_PCM));
    # STEP 5: Wait dynamically for the player to finish before starting the next pipeline step
    - wait_until:
        timeout: 1000ms
        condition:
          lambda: 'return !id(i2s_speaker_out).is_running();'
    - logger.log:
        level: WARN
        format: "VA: Feedback finished, I2S bus ready for response"

  on_stt_end:
    - logger.log:
        level: WARN
        format: "VA STT: %s"
        args: ['x.c_str()']
    - lambda: |-
        id(va_state).publish_state("Recognized: " + x);

  on_tts_start:
    - logger.log:
        level: WARN
        format: "VA TTS: %s"
        args: ['x.c_str()']
    - lambda: |-
        id(va_state).publish_state("Response: " + x);

  on_tts_end:
    - logger.log:
        level: WARN
        format: "VA: TTS Finished"

  on_tts_stream_start:
    - globals.set:
        id: has_tts_response
        value: 'true'
    # CRITICAL FALLBACK: Ensure the wake word model releases its lock BEFORE the speaker stream starts!
    # Without this, the speaker might crash with "Parent I2S bus not free"
    - micro_wake_word.stop:
    - lambda: 'id(my_mic).stop();'
    # Send a tiny silent primer to wake up the DAC and amplifier
    # This ensures no syllables are cut off while hardware powers up
    - lambda: |-
        std::vector<uint8_t> primer(3200, 0);
        id(announcement_spk_resampler).play(primer.data(), primer.size());
    - delay: 300ms
    - logger.log:
        level: WARN
        format: "VA: Audio stream starting..."
    - lambda: |-
        id(va_state).publish_state("Playing Audio...");

  on_tts_stream_end:
    - logger.log:
        level: WARN
        format: "VA: Audio stream finished"

  on_end:
    - logger.log:
        level: WARN
        format: "VA: Pipeline ended"
    # Wait for the speaker to finalize the last bits of the response
    - script.execute: wait_and_restart_wakeword

  on_error:
    - logger.log:
        level: ERROR
        format: "VA Error: %s (Code: %s)"
        args: ['code.c_str()', 'message.c_str()']
    - lambda: |-
        id(va_state).publish_state("Error!");
    - delay: 2s
    - micro_wake_word.start:

# -------------------------------------------------------------------
# HELPER SCRIPT: ASYNC WAKE WORD RESTART
# -------------------------------------------------------------------
# This script waits until the speaker is idle before re-enabling MWW.
# This prevents MWW from crashing the speaker during a stream.
script:
  - id: wait_and_restart_wakeword
    mode: restart
    then:
      - if:
          condition:
            lambda: 'return id(has_tts_response);'
          then:
            - wait_until:
                timeout: 2s
                condition:
                  lambda: 'return id(i2s_speaker_out).is_running();'
            - logger.log:
                level: WARN
                format: "Speaker active, waiting for end..."
            - wait_until:
                timeout: 60s
                condition:
                  lambda: 'return !id(i2s_speaker_out).is_running();'
      - logger.log:
          level: WARN
          format: "Speaker stopped, restarting Wake Word..."
      - delay: 100ms
      - micro_wake_word.start:
      - lambda: |-
          id(va_state).publish_state("Ready (Hey Jarvis)");

# -------------------------------------------------------------------
# HOME ASSISTANT CONTROLS (Numbers & Buttons)
# -------------------------------------------------------------------
number:
  # Allows runtime microphone sensitivity adjustment on the ES8311 Codec
  - platform: template
    name: "Microphone Gain"
    id: mic_gain_control
    min_value: 0
    max_value: 42
    step: 3
    unit_of_measurement: "dB"
    initial_value: 42
    optimistic: true
    on_value:
      - lambda: |-
          uint8_t index = (uint8_t)(x / 3.0);
          if (index > 14) index = 14; 
          uint8_t reg_val = 0x10 | index; 
          id(es8311_dac).write_byte(0x14, reg_val);
          ESP_LOGI("config", "ES8311 Mic Gain set to: %.0f dB (Reg 0x14: 0x%02X)", x, reg_val);

  - platform: template
    name: "Noise Suppression Level"
    id: ns_level_control
    min_value: 0
    max_value: 4
    step: 1
    initial_value: 2
    optimistic: true
    on_value:
      - lambda: |-
          ESP_LOGI("config", "New Noise Suppression Level: %.0f", x);

  # Hardware volume control for the onboard speaker
  - platform: template
    name: "Speaker Volume"
    id: spk_volume_control
    min_value: 0
    max_value: 100
    step: 1
    unit_of_measurement: "%"
    initial_value: 80
    optimistic: true
    on_value:
      - lambda: |-
          uint8_t reg_val = (uint8_t)((100.0 - x) * 1.9); 
          id(es8311_dac).write_byte(0x32, reg_val);
          ESP_LOGI("config", "Speaker Volume set to: %.0f%% (Reg 0x32: 0x%02X)", x, reg_val);

# -------------------------------------------------------------------
# AMPLIFIER CONTROL
# -------------------------------------------------------------------
switch:
  - platform: gpio
    pin: GPIO53
    name: "Amplifier Enable"
    id: amp_enable
    restore_mode: ALWAYS_ON

# -------------------------------------------------------------------
# DIAGNOSTIC TOOLS
# -------------------------------------------------------------------
button:
  - platform: template
    name: "Speaker Diagnostics"
    id: speaker_diag
    icon: "mdi:stethoscope"
    on_press:
      - lambda: |-
          ESP_LOGW("diag", "========== DIAGNOSTICS ==========");
          ESP_LOGW("diag", "Free Heap: %u bytes", esp_get_free_heap_size());
          ESP_LOGW("diag", "Amp: %s", id(amp_enable).state ? "ON" : "OFF");
          uint8_t val;
          id(es8311_dac).read_byte(0x37, &val);
          ESP_LOGW("diag", "DAC Power (0x37): 0x%02X (0x08=on)", val);
          id(es8311_dac).read_byte(0x33, &val);
          ESP_LOGW("diag", "DAC Mute (0x33): 0x%02X (0x00=unmuted)", val);
          ESP_LOGW("diag", "=================================");

  - platform: template
    name: "Play Test Sound"
    id: play_test_tone_synth
    icon: "mdi:volume-high"
    on_press:
      - micro_wake_word.stop:
      - delay: 500ms
      - lambda: |-
          std::vector<uint8_t> data;
          for (int i = 0; i < 8000; i++) {
              int16_t sample = ((i / 8) % 2 == 0) ? 32000 : -32000;
              data.push_back(sample & 0xFF);
              data.push_back((sample >> 8) & 0xFF);
          }
          id(announcement_spk_resampler).play(data.data(), data.size());
          ESP_LOGI("test", "Test tone played");
      - delay: 2000ms
      - micro_wake_word.start:

# -------------------------------------------------------------------
# UI STATE SENSOR
# -------------------------------------------------------------------
text_sensor:
  - platform: template
    name: "Voice Assistant State"
    id: va_state
    lambda: |-
      return {};
    update_interval: never
